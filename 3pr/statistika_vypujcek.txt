
CREATE OR REPLACE PROCEDURE STATISTIKA_VYPUJCEK(p_osoby_id IN NUMBER)
    IS FNAME VARCHAR2(10000);
    EXEMPLARCOUNT NUMBER;
    OWNEDCOUNT NUMBER; 
    REPEATCOUNT NUMBER;
begin
    SELECT PRIJMENI || ' ' || JMENO INTO FNAME FROM OSOBA WHERE ID_OSOBY = p_osoby_id;
    IF SQL%NOTFOUND THEN RAISE_APPLICATION_ERROR(-123456, 'osoba neexistuje!');
    ELSE 
      SELECT COUNT(ID_VYPUJCKY) INTO EXEMPLARCOUNT FROM VYPUJCKA WHERE ID_OSOBY = p_osoby_id;

        SELECT COUNT(ID_VYPUJCKY) INTO OWNEDCOUNT FROM VYPUJCKA 
            JOIN EXEMPLAR ON (VYPUJCKA.ID_EXEMPLARE = EXEMPLAR.ID_EXEMPLARE)
            JOIN OSOBA ON (VYPUJCKA.ID_OSOBY = OSOBA.ID_OSOBY)
            WHERE EXEMPLAR.ID_OSOBY = p_osoby_id;

        SELECT COUNT(ID_EXEMPLARE) INTO REPEATCOUNT FROM (
            SELECT ID_EXEMPLARE FROM VYPUJCKA
            WHERE p_osoby_id = ID_OSOBY
            HAVING COUNT(ID_EXEMPLARE) > 1
            GROUP BY ID_EXEMPLARE
        );


        DBMS_OUTPUT.PUT_LINE('' || FNAME || '');
        DBMS_OUTPUT.PUT_LINE('# pocet vypujcenych exemplaru: ' || EXEMPLARCOUNT);
        DBMS_OUTPUT.PUT_LINE('# počet vypůjčených exemplářů, jejichž knihu má ve svém držení: ' || OWNEDCOUNT);
        DBMS_OUTPUT.PUT_LINE('# počet opakovaně vypůjčených knih: ' || REPEATCOUNT);

    END IF;
END;

