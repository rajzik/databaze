


CREATE OR REPLACE TRIGGER DML_OPERATIONS INSTEAD OF INSERT OR UPDATE OR DELETE ON NASE_KNIHOVNA

FOR EACH ROW
DECLARE
    HELP NUMBER;
    INEED NUMBER;
    SOMEBODY NUMBER;

BEGIN

    CASE
        WHEN INSERTING THEN
            DBMS_OUTPUT.PUT_LINE('TOO lazy to do that!');
        WHEN UPDATING THEN
            SELECT ID_KNIHY into HELP FROM EXEMPLAR
            WHERE ID_EXEMPLARE = :OLD.IDEXEMPLARE;

            UPDATE KNIHA SET NAZEV = :NEW.NAZEV, AUTOR = :NEW.AUTOR, NAKLADATEL = :NEW.NAKLADATEL, EDICE = :NEW.EDICE, MISTO_VYDANI = :NEW.MISTO, ROK_VYDANI = :NEW.ROK
            WHERE ID_KNIHY = HELP;

            SELECT COUNT(*) INTO INEED FROM OSOBA 
                WHERE LOGIN = :NEW.VLASTNIK;

            IF INEED <= 0 THEN
                RAISE_APPLICATION_ERROR(-12345, 'Janek jde, a taky vlastnik neexistuje!');
            ELSE
                SELECT ID_OSOBY INTO SOMEBODY FROM OSOBA WHERE LOGIN = :NEW.VLASTNIK;
                UPDATE EXEMPLAR SET ID_OSOBY = SOMEBODY
                    WHERE ID_EXEMPLARE = :OLD.IDEXEMPLARE;
            END IF;

        WHEN DELETING THEN
            DELETE FROM EXEMPLAR
                WHERE ID_EXEMPLARE = :OLD.IDEXEMPLARE;
    END CASE;

END;
